{"ast":null,"code":"import _JSON$stringify from \"@babel/runtime-corejs2/core-js/json/stringify\";\nimport React from \"react\";\nvar __jsx = React.createElement;\nimport Layout from '../components/Layout';\nimport fetch from 'isomorphic-unfetch';\nimport Alert from 'react-bootstrap/Alert';\nimport PollChoices from '../components/PollChoices';\nimport PollResults from '../components/PollResults';\nimport { withRouter } from 'next/router';\nimport ErrorPage from './_error';\nimport absoluteUrl from 'next-absolute-url';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport FormControl from 'react-bootstrap/FormControl';\nimport Button from 'react-bootstrap/Button';\nimport ShareButton from '../components/ShareButton';\nimport { ReportButton } from '../components/Report';\nimport Row from 'react-bootstrap/Row';\nimport Col from 'react-bootstrap/Col';\nimport io from 'socket.io-client';\nimport moment from 'moment';\nimport getMomentTimelimit from '../helpers/momentFunctions';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { faInfoCircle } from '@fortawesome/free-solid-svg-icons';\n\nclass PollPage extends React.Component {\n  static async getInitialProps(ctx) {\n    const {\n      origin\n    } = absoluteUrl(ctx.req);\n    const {\n      slug\n    } = ctx.query;\n    let clientIp;\n\n    if (ctx.req && ctx.req.headers) {\n      clientIp = ctx.req.headers['x-forwarded-for'] || ctx.req.connection.remoteAddress;\n    }\n\n    const res = await fetch(`${origin}/api/v1/poll/${slug}`, {\n      method: 'POST',\n      headers: {\n        'X-IP': clientIp\n      }\n    });\n    const errorCode = res.status > 200 ? res.status : false;\n    const data = await res.json();\n    const url = `${origin}/poll/${slug}`;\n    return {\n      errorCode,\n      poll: data.pollData,\n      user: data.userData,\n      url: url\n    };\n  }\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      totalVotes: this.props.poll.totalVotes,\n      results: this.props.poll.results,\n      userDidVote: this.props.user.didVote,\n      revealResults: !this.props.poll.active,\n      resultsLoading: false,\n      refreshResultsLoading: false,\n      selectedVote: null,\n      userDidVoteError: false,\n      submitError: false,\n      timelimit: this.props.poll.timelimit\n    };\n    this.updateChoiceSelected = this.updateChoiceSelected.bind(this);\n    this.loadResults = this.loadResults.bind(this);\n    this.submitVote = this.submitVote.bind(this);\n    this.connectSocket = this.connectSocket.bind(this);\n  }\n\n  componentDidMount() {\n    if (this.props.poll.active) {\n      this.connectSocket();\n      const updateTimelimit = setInterval(() => {\n        let timelimit = getMomentTimelimit(this.props.poll.dateCreated, this.props.poll.votingPeriod);\n        this.setState({\n          timelimit: timelimit\n        });\n      }, 60000);\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.socket) {\n      this.socket.close();\n    }\n\n    clearInterval(this.updateTimelimit);\n  }\n\n  connectSocket() {\n    this.socket = io();\n    this.socket.emit('joinPollRoom', this.props.router.query.slug);\n    this.socket.on('joined', data => {\n      console.log('PollRoom:', data);\n    });\n    this.socket.on('updateResults', selectedVote => {\n      const newResults = this.state.results.slice(0);\n      newResults[selectedVote]++;\n      this.setState({\n        results: newResults,\n        totalVotes: this.state.totalVotes + 1\n      });\n    });\n  }\n\n  updateChoiceSelected(e) {\n    this.setState({\n      selectedVote: e.target.value\n    });\n  }\n\n  async loadResults(e, req) {\n    const {\n      origin\n    } = absoluteUrl(req);\n    const {\n      slug\n    } = this.props.router.query;\n\n    if (this.state.revealResults || this.state.userDidVote || this.props.active) {\n      this.setState({\n        refreshResultsLoading: true,\n        revealResults: true\n      });\n    } else {\n      this.setState({\n        revealResults: true,\n        resultsLoading: true\n      });\n    }\n\n    try {\n      const res = await fetch(`${origin}/api/v1/poll/results/${slug}`, {\n        method: 'POST'\n      });\n      const data = await res.json();\n      this.setState({\n        totalVotes: data.totalVotes,\n        userDidVote: data.userDidVote,\n        results: data.results,\n        resultsLoading: false,\n        refreshResultsLoading: false\n      });\n    } catch (err) {}\n  }\n\n  async submitVote(e, req) {\n    e.preventDefault();\n\n    if (this.state.selectedVote !== null) {\n      const {\n        origin\n      } = absoluteUrl(req);\n      const {\n        slug\n      } = this.props.router.query;\n\n      try {\n        const res = await fetch(`${origin}/api/v1/poll/vote/${slug}`, {\n          method: 'POST',\n          headers: {\n            'Accept': 'accplication/json',\n            'Content-Type': 'application/json'\n          },\n          body: _JSON$stringify({\n            selectedVote: this.state.selectedVote\n          })\n        });\n        const data = await res.json();\n\n        if (data.message === 'error') {\n          this.setState({\n            userDidVoteError: true\n          });\n        } else {\n          if (localStorage.voteHistory) {\n            let voteHistory = JSON.parse(localStorage.getItem('voteHistory'));\n            voteHistory.unshift({\n              title: this.props.poll.title,\n              url: this.props.router.query.slug\n            });\n            voteHistory = _JSON$stringify(voteHistory);\n            localStorage.setItem('voteHistory', voteHistory);\n          } else {\n            let voteHistory = [];\n            voteHistory.unshift({\n              title: this.props.poll.title,\n              url: this.props.router.query.slug\n            });\n            voteHistory = _JSON$stringify(voteHistory);\n            localStorage.setItem('voteHistory', voteHistory);\n          }\n\n          this.setState({\n            userDidVote: true\n          });\n        }\n      } catch (err) {\n        this.setState({\n          submitError: true\n        });\n      }\n    } else {// user didnt select vote\n    }\n  }\n\n  render() {\n    // if not data found for poll\n    if (this.props.errorCode) {\n      return __jsx(ErrorPage, {\n        errorCode: this.props.errorCode\n      });\n    }\n\n    const {\n      url\n    } = this.props;\n    const {\n      title,\n      desc,\n      visibility,\n      active,\n      choices,\n      dateCreated,\n      visits,\n      category\n    } = this.props.poll;\n    const {\n      totalVotes,\n      results,\n      userDidVote,\n      userDidVoteError,\n      revealResults,\n      resultsLoading,\n      refreshResultsLoading,\n      submitError,\n      selectedVote,\n      timelimit\n    } = this.state;\n    return __jsx(Layout, {\n      pageTitle: `Poll - ${title}`,\n      pageDesc: desc,\n      visibility: visibility,\n      path: this.props.router.asPath,\n      ads: true\n    }, __jsx(\"div\", {\n      className: \"poll-wrapper\"\n    }, visibility === 'private' ? __jsx(\"div\", {\n      className: \"poll-alert\"\n    }, __jsx(Alert, {\n      variant: \"danger\"\n    }, \"This is a \", __jsx(\"b\", null, \"private\"), \" poll. Please consider before sharing the link.\")) : null, __jsx(\"h4\", {\n      className: \"poll-title\"\n    }, title.length > 0 ? title : 'Untitled'), __jsx(\"hr\", null), __jsx(\"div\", {\n      className: \"poll-desc mb-1\"\n    }, __jsx(\"h6\", null, \"Description\"), __jsx(\"div\", null, __jsx(\"p\", null, desc.length > 0 ? desc : __jsx(\"i\", null, \"No description\")), __jsx(\"hr\", null), __jsx(\"div\", {\n      className: \"poll-stat\"\n    }, \"Category: \", category), __jsx(\"div\", {\n      className: \"poll-stat\"\n    }, visits, \" views \\u2022 \", moment.utc(dateCreated).local().format('ll')))), __jsx(Row, null, __jsx(Col, null, __jsx(\"div\", {\n      className: \"poll-options mb-3\"\n    }, __jsx(ShareButton, {\n      url: url\n    }), __jsx(ReportButton, {\n      urlref: this.props.router.query.slug,\n      polltitle: title\n    })))), __jsx(\"div\", {\n      className: \"poll-time\"\n    }, __jsx(\"h6\", null, __jsx(FontAwesomeIcon, {\n      icon: faInfoCircle,\n      style: {\n        marginRight: '0.25rem'\n      }\n    }), \" \", __jsx(\"b\", null, totalVotes), \" votes \\u2022 \", active && timelimit != 'Voting has ended' ? 'Voting ends in:' : null, \" \", __jsx(\"b\", null, timelimit))), active && !userDidVote ? __jsx(PollChoices, {\n      userDidVote: userDidVote,\n      userDidVoteError: userDidVoteError,\n      submitError: submitError,\n      choices: choices,\n      revealResults: revealResults,\n      updateChoiceSelected: this.updateChoiceSelected,\n      submitVote: this.submitVote,\n      loadResults: this.loadResults,\n      selectedVote: selectedVote\n    }) : null, !active || userDidVote || revealResults ? __jsx(PollResults, {\n      totalVotes: totalVotes,\n      results: results,\n      choices: choices,\n      resultsLoading: resultsLoading,\n      refreshResultsLoading: refreshResultsLoading,\n      loadResults: this.loadResults,\n      active: active\n    }) : null));\n  }\n\n}\n\nPollPage.defaultProps = {\n  poll: {\n    totalVotes: 0,\n    results: []\n  },\n  user: {\n    userDidVote: false\n  },\n  revealResults: false,\n  active: true\n};\nexport default withRouter(PollPage);","map":{"version":3,"sources":["E:/Users/Jordan/Desktop/thatpoll/pages/poll.js"],"names":["Layout","fetch","Alert","PollChoices","PollResults","withRouter","ErrorPage","absoluteUrl","InputGroup","FormControl","Button","ShareButton","ReportButton","Row","Col","io","moment","getMomentTimelimit","FontAwesomeIcon","faInfoCircle","PollPage","React","Component","getInitialProps","ctx","origin","req","slug","query","clientIp","headers","connection","remoteAddress","res","method","errorCode","status","data","json","url","poll","pollData","user","userData","constructor","props","state","totalVotes","results","userDidVote","didVote","revealResults","active","resultsLoading","refreshResultsLoading","selectedVote","userDidVoteError","submitError","timelimit","updateChoiceSelected","bind","loadResults","submitVote","connectSocket","componentDidMount","updateTimelimit","setInterval","dateCreated","votingPeriod","setState","componentWillUnmount","socket","close","clearInterval","emit","router","on","console","log","newResults","slice","e","target","value","err","preventDefault","body","message","localStorage","voteHistory","JSON","parse","getItem","unshift","title","setItem","render","desc","visibility","choices","visits","category","asPath","length","utc","local","format","marginRight","defaultProps"],"mappings":";;;AAAA,OAAOA,MAAP,MAAmB,sBAAnB;AACA,OAAOC,KAAP,MAAkB,oBAAlB;AACA,OAAOC,KAAP,MAAkB,uBAAlB;AACA,OAAOC,WAAP,MAAwB,2BAAxB;AACA,OAAOC,WAAP,MAAwB,2BAAxB;AACA,SAASC,UAAT,QAA2B,aAA3B;AACA,OAAOC,SAAP,MAAsB,UAAtB;AACA,OAAOC,WAAP,MAAwB,mBAAxB;AACA,OAAOC,UAAP,MAAuB,4BAAvB;AACA,OAAOC,WAAP,MAAwB,6BAAxB;AACA,OAAOC,MAAP,MAAmB,wBAAnB;AACA,OAAOC,WAAP,MAAwB,2BAAxB;AACA,SAASC,YAAT,QAA6B,sBAA7B;AACA,OAAOC,GAAP,MAAgB,qBAAhB;AACA,OAAOC,GAAP,MAAgB,qBAAhB;AACA,OAAOC,EAAP,MAAe,kBAAf;AACA,OAAOC,MAAP,MAAmB,QAAnB;AACA,OAAOC,kBAAP,MAA+B,4BAA/B;AACA,SAASC,eAAT,QAAgC,gCAAhC;AACA,SAASC,YAAT,QAA6B,mCAA7B;;AAGA,MAAMC,QAAN,SAAuBC,KAAK,CAACC,SAA7B,CAAuC;AACrC,eAAaC,eAAb,CAA6BC,GAA7B,EAAkC;AAChC,UAAM;AAAEC,MAAAA;AAAF,QAAalB,WAAW,CAACiB,GAAG,CAACE,GAAL,CAA9B;AACA,UAAM;AAAEC,MAAAA;AAAF,QAAWH,GAAG,CAACI,KAArB;AACA,QAAIC,QAAJ;;AACA,QAAIL,GAAG,CAACE,GAAJ,IAAWF,GAAG,CAACE,GAAJ,CAAQI,OAAvB,EAAgC;AAC9BD,MAAAA,QAAQ,GAAGL,GAAG,CAACE,GAAJ,CAAQI,OAAR,CAAgB,iBAAhB,KAAsCN,GAAG,CAACE,GAAJ,CAAQK,UAAR,CAAmBC,aAApE;AACD;;AACD,UAAMC,GAAG,GAAG,MAAMhC,KAAK,CAAE,GAAEwB,MAAO,gBAAeE,IAAK,EAA/B,EAAkC;AACvDO,MAAAA,MAAM,EAAE,MAD+C;AAEvDJ,MAAAA,OAAO,EAAE;AACP,gBAAQD;AADD;AAF8C,KAAlC,CAAvB;AAMA,UAAMM,SAAS,GAAGF,GAAG,CAACG,MAAJ,GAAa,GAAb,GAAmBH,GAAG,CAACG,MAAvB,GAAgC,KAAlD;AACA,UAAMC,IAAI,GAAG,MAAMJ,GAAG,CAACK,IAAJ,EAAnB;AACA,UAAMC,GAAG,GAAI,GAAEd,MAAO,SAAQE,IAAK,EAAnC;AACA,WAAO;AAAEQ,MAAAA,SAAF;AAAaK,MAAAA,IAAI,EAAEH,IAAI,CAACI,QAAxB;AAAkCC,MAAAA,IAAI,EAAEL,IAAI,CAACM,QAA7C;AAAuDJ,MAAAA,GAAG,EAAEA;AAA5D,KAAP;AACD;;AAEDK,EAAAA,WAAW,CAACC,KAAD,EAAQ;AACjB,UAAMA,KAAN;AAEA,SAAKC,KAAL,GAAa;AACXC,MAAAA,UAAU,EAAE,KAAKF,KAAL,CAAWL,IAAX,CAAgBO,UADjB;AAEXC,MAAAA,OAAO,EAAE,KAAKH,KAAL,CAAWL,IAAX,CAAgBQ,OAFd;AAGXC,MAAAA,WAAW,EAAE,KAAKJ,KAAL,CAAWH,IAAX,CAAgBQ,OAHlB;AAIXC,MAAAA,aAAa,EAAE,CAAC,KAAKN,KAAL,CAAWL,IAAX,CAAgBY,MAJrB;AAKXC,MAAAA,cAAc,EAAE,KALL;AAMXC,MAAAA,qBAAqB,EAAE,KANZ;AAOXC,MAAAA,YAAY,EAAE,IAPH;AAQXC,MAAAA,gBAAgB,EAAE,KARP;AASXC,MAAAA,WAAW,EAAE,KATF;AAUXC,MAAAA,SAAS,EAAE,KAAKb,KAAL,CAAWL,IAAX,CAAgBkB;AAVhB,KAAb;AAaA,SAAKC,oBAAL,GAA4B,KAAKA,oBAAL,CAA0BC,IAA1B,CAA+B,IAA/B,CAA5B;AACA,SAAKC,WAAL,GAAmB,KAAKA,WAAL,CAAiBD,IAAjB,CAAsB,IAAtB,CAAnB;AACA,SAAKE,UAAL,GAAkB,KAAKA,UAAL,CAAgBF,IAAhB,CAAqB,IAArB,CAAlB;AACA,SAAKG,aAAL,GAAqB,KAAKA,aAAL,CAAmBH,IAAnB,CAAwB,IAAxB,CAArB;AACD;;AAEDI,EAAAA,iBAAiB,GAAG;AAClB,QAAI,KAAKnB,KAAL,CAAWL,IAAX,CAAgBY,MAApB,EAA4B;AAC1B,WAAKW,aAAL;AACA,YAAME,eAAe,GAAGC,WAAW,CAAC,MAAM;AACxC,YAAIR,SAAS,GAAGzC,kBAAkB,CAAC,KAAK4B,KAAL,CAAWL,IAAX,CAAgB2B,WAAjB,EAA8B,KAAKtB,KAAL,CAAWL,IAAX,CAAgB4B,YAA9C,CAAlC;AACA,aAAKC,QAAL,CAAc;AACZX,UAAAA,SAAS,EAAEA;AADC,SAAd;AAGD,OALkC,EAKhC,KALgC,CAAnC;AAMD;AACF;;AAEDY,EAAAA,oBAAoB,GAAG;AACrB,QAAI,KAAKC,MAAT,EAAiB;AACf,WAAKA,MAAL,CAAYC,KAAZ;AACD;;AACDC,IAAAA,aAAa,CAAC,KAAKR,eAAN,CAAb;AACD;;AAEDF,EAAAA,aAAa,GAAG;AACd,SAAKQ,MAAL,GAAcxD,EAAE,EAAhB;AACA,SAAKwD,MAAL,CAAYG,IAAZ,CAAiB,cAAjB,EAAiC,KAAK7B,KAAL,CAAW8B,MAAX,CAAkB/C,KAAlB,CAAwBD,IAAzD;AAEA,SAAK4C,MAAL,CAAYK,EAAZ,CAAe,QAAf,EAAyBvC,IAAI,IAAI;AAC/BwC,MAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ,EAAyBzC,IAAzB;AACD,KAFD;AAIA,SAAKkC,MAAL,CAAYK,EAAZ,CAAe,eAAf,EAAgCrB,YAAY,IAAI;AAC9C,YAAMwB,UAAU,GAAG,KAAKjC,KAAL,CAAWE,OAAX,CAAmBgC,KAAnB,CAAyB,CAAzB,CAAnB;AACAD,MAAAA,UAAU,CAACxB,YAAD,CAAV;AACA,WAAKc,QAAL,CAAc;AACZrB,QAAAA,OAAO,EAAE+B,UADG;AAEZhC,QAAAA,UAAU,EAAE,KAAKD,KAAL,CAAWC,UAAX,GAAwB;AAFxB,OAAd;AAID,KAPD;AAQD;;AAEDY,EAAAA,oBAAoB,CAACsB,CAAD,EAAI;AACtB,SAAKZ,QAAL,CAAc;AAAEd,MAAAA,YAAY,EAAE0B,CAAC,CAACC,MAAF,CAASC;AAAzB,KAAd;AACD;;AAED,QAAMtB,WAAN,CAAkBoB,CAAlB,EAAqBvD,GAArB,EAA0B;AACxB,UAAM;AAAED,MAAAA;AAAF,QAAalB,WAAW,CAACmB,GAAD,CAA9B;AACA,UAAM;AAAEC,MAAAA;AAAF,QAAW,KAAKkB,KAAL,CAAW8B,MAAX,CAAkB/C,KAAnC;;AAEA,QAAI,KAAKkB,KAAL,CAAWK,aAAX,IAA4B,KAAKL,KAAL,CAAWG,WAAvC,IAAsD,KAAKJ,KAAL,CAAWO,MAArE,EAA6E;AAC3E,WAAKiB,QAAL,CAAc;AAAEf,QAAAA,qBAAqB,EAAE,IAAzB;AAA+BH,QAAAA,aAAa,EAAE;AAA9C,OAAd;AACD,KAFD,MAEO;AACL,WAAKkB,QAAL,CAAc;AAAElB,QAAAA,aAAa,EAAE,IAAjB;AAAuBE,QAAAA,cAAc,EAAE;AAAvC,OAAd;AACD;;AAED,QAAI;AACF,YAAMpB,GAAG,GAAG,MAAMhC,KAAK,CAAE,GAAEwB,MAAO,wBAAuBE,IAAK,EAAvC,EAA0C;AAC/DO,QAAAA,MAAM,EAAE;AADuD,OAA1C,CAAvB;AAGA,YAAMG,IAAI,GAAG,MAAMJ,GAAG,CAACK,IAAJ,EAAnB;AAEA,WAAK+B,QAAL,CAAc;AACZtB,QAAAA,UAAU,EAAEV,IAAI,CAACU,UADL;AAEZE,QAAAA,WAAW,EAAEZ,IAAI,CAACY,WAFN;AAGZD,QAAAA,OAAO,EAAEX,IAAI,CAACW,OAHF;AAIZK,QAAAA,cAAc,EAAE,KAJJ;AAKZC,QAAAA,qBAAqB,EAAE;AALX,OAAd;AAOD,KAbD,CAaE,OAAO8B,GAAP,EAAY,CAEb;AACF;;AAED,QAAMtB,UAAN,CAAiBmB,CAAjB,EAAoBvD,GAApB,EAAyB;AACvBuD,IAAAA,CAAC,CAACI,cAAF;;AACA,QAAG,KAAKvC,KAAL,CAAWS,YAAX,KAA4B,IAA/B,EAAqC;AACnC,YAAM;AAAE9B,QAAAA;AAAF,UAAalB,WAAW,CAACmB,GAAD,CAA9B;AACA,YAAM;AAAEC,QAAAA;AAAF,UAAW,KAAKkB,KAAL,CAAW8B,MAAX,CAAkB/C,KAAnC;;AACA,UAAI;AACF,cAAMK,GAAG,GAAG,MAAMhC,KAAK,CAAE,GAAEwB,MAAO,qBAAoBE,IAAK,EAApC,EAAuC;AAC5DO,UAAAA,MAAM,EAAE,MADoD;AAE5DJ,UAAAA,OAAO,EAAE;AACP,sBAAU,mBADH;AAEP,4BAAgB;AAFT,WAFmD;AAM5DwD,UAAAA,IAAI,EAAE,gBAAe;AAAC/B,YAAAA,YAAY,EAAE,KAAKT,KAAL,CAAWS;AAA1B,WAAf;AANsD,SAAvC,CAAvB;AASA,cAAMlB,IAAI,GAAG,MAAMJ,GAAG,CAACK,IAAJ,EAAnB;;AAEA,YAAGD,IAAI,CAACkD,OAAL,KAAiB,OAApB,EAA6B;AAC3B,eAAKlB,QAAL,CAAc;AAAEb,YAAAA,gBAAgB,EAAE;AAApB,WAAd;AACD,SAFD,MAEO;AACL,cAAIgC,YAAY,CAACC,WAAjB,EAA8B;AAC5B,gBAAIA,WAAW,GAAGC,IAAI,CAACC,KAAL,CAAWH,YAAY,CAACI,OAAb,CAAqB,aAArB,CAAX,CAAlB;AACAH,YAAAA,WAAW,CAACI,OAAZ,CAAoB;AAAEC,cAAAA,KAAK,EAAE,KAAKjD,KAAL,CAAWL,IAAX,CAAgBsD,KAAzB;AAAgCvD,cAAAA,GAAG,EAAE,KAAKM,KAAL,CAAW8B,MAAX,CAAkB/C,KAAlB,CAAwBD;AAA7D,aAApB;AACA8D,YAAAA,WAAW,GAAG,gBAAeA,WAAf,CAAd;AACAD,YAAAA,YAAY,CAACO,OAAb,CAAqB,aAArB,EAAoCN,WAApC;AACD,WALD,MAKO;AACL,gBAAIA,WAAW,GAAG,EAAlB;AACAA,YAAAA,WAAW,CAACI,OAAZ,CAAoB;AAAEC,cAAAA,KAAK,EAAE,KAAKjD,KAAL,CAAWL,IAAX,CAAgBsD,KAAzB;AAAgCvD,cAAAA,GAAG,EAAE,KAAKM,KAAL,CAAW8B,MAAX,CAAkB/C,KAAlB,CAAwBD;AAA7D,aAApB;AACA8D,YAAAA,WAAW,GAAG,gBAAeA,WAAf,CAAd;AACAD,YAAAA,YAAY,CAACO,OAAb,CAAqB,aAArB,EAAoCN,WAApC;AACD;;AAED,eAAKpB,QAAL,CAAc;AAAEpB,YAAAA,WAAW,EAAE;AAAf,WAAd;AACD;AAEF,OA9BD,CA8BE,OAAOmC,GAAP,EAAY;AACZ,aAAKf,QAAL,CAAc;AAAEZ,UAAAA,WAAW,EAAE;AAAf,SAAd;AACD;AACF,KApCD,MAoCO,CACL;AACD;AACF;;AAEDuC,EAAAA,MAAM,GAAG;AACP;AACA,QAAI,KAAKnD,KAAL,CAAWV,SAAf,EAA0B;AACxB,aAAO,MAAC,SAAD;AAAW,QAAA,SAAS,EAAE,KAAKU,KAAL,CAAWV;AAAjC,QAAP;AACD;;AAED,UAAM;AAAEI,MAAAA;AAAF,QAAU,KAAKM,KAArB;AAEA,UAAM;AACJiD,MAAAA,KADI;AAEJG,MAAAA,IAFI;AAGJC,MAAAA,UAHI;AAIJ9C,MAAAA,MAJI;AAKJ+C,MAAAA,OALI;AAMJhC,MAAAA,WANI;AAOJiC,MAAAA,MAPI;AAQJC,MAAAA;AARI,QASF,KAAKxD,KAAL,CAAWL,IATf;AAWA,UAAM;AACJO,MAAAA,UADI;AAEJC,MAAAA,OAFI;AAGJC,MAAAA,WAHI;AAIJO,MAAAA,gBAJI;AAKJL,MAAAA,aALI;AAMJE,MAAAA,cANI;AAOJC,MAAAA,qBAPI;AAQJG,MAAAA,WARI;AASJF,MAAAA,YATI;AAUJG,MAAAA;AAVI,QAWF,KAAKZ,KAXT;AAaA,WACE,MAAC,MAAD;AACE,MAAA,SAAS,EAAG,UAASgD,KAAM,EAD7B;AAEE,MAAA,QAAQ,EAAEG,IAFZ;AAGE,MAAA,UAAU,EAAEC,UAHd;AAIE,MAAA,IAAI,EAAE,KAAKrD,KAAL,CAAW8B,MAAX,CAAkB2B,MAJ1B;AAKE,MAAA,GAAG,EAAE;AALP,OAOE;AAAK,MAAA,SAAS,EAAC;AAAf,OACGJ,UAAU,KAAK,SAAf,GACC;AAAK,MAAA,SAAS,EAAC;AAAf,OACE,MAAC,KAAD;AAAO,MAAA,OAAO,EAAC;AAAf,qBACY,2BADZ,oDADF,CADD,GAMC,IAPJ,EAQE;AAAI,MAAA,SAAS,EAAC;AAAd,OAA4BJ,KAAK,CAACS,MAAN,GAAe,CAAf,GAAmBT,KAAnB,GAA2B,UAAvD,CARF,EASE,iBATF,EAUE;AAAK,MAAA,SAAS,EAAC;AAAf,OACE,gCADF,EAEE,mBACE,iBACGG,IAAI,CAACM,MAAL,GAAc,CAAd,GAAkBN,IAAlB,GAAyB,kCAD5B,CADF,EAIE,iBAJF,EAKE;AAAK,MAAA,SAAS,EAAC;AAAf,qBACaI,QADb,CALF,EAQE;AAAK,MAAA,SAAS,EAAC;AAAf,OACGD,MADH,oBACoBpF,MAAM,CAACwF,GAAP,CAAWrC,WAAX,EAAwBsC,KAAxB,GAAgCC,MAAhC,CAAuC,IAAvC,CADpB,CARF,CAFF,CAVF,EAyBE,MAAC,GAAD,QACE,MAAC,GAAD,QACE;AAAK,MAAA,SAAS,EAAC;AAAf,OACE,MAAC,WAAD;AAAa,MAAA,GAAG,EAAEnE;AAAlB,MADF,EAEE,MAAC,YAAD;AAAc,MAAA,MAAM,EAAE,KAAKM,KAAL,CAAW8B,MAAX,CAAkB/C,KAAlB,CAAwBD,IAA9C;AAAoD,MAAA,SAAS,EAAEmE;AAA/D,MAFF,CADF,CADF,CAzBF,EAiCE;AAAK,MAAA,SAAS,EAAC;AAAf,OACE,kBACE,MAAC,eAAD;AAAiB,MAAA,IAAI,EAAE3E,YAAvB;AAAqC,MAAA,KAAK,EAAE;AAAEwF,QAAAA,WAAW,EAAE;AAAf;AAA5C,MADF,OAC6E,iBAAI5D,UAAJ,CAD7E,oBAC0GK,MAAM,IAAIM,SAAS,IAAI,kBAAvB,GAA4C,iBAA5C,GAAgE,IAD1K,OACiL,iBAAIA,SAAJ,CADjL,CADF,CAjCF,EAsCIN,MAAM,IAAI,CAACH,WAAX,GACF,MAAC,WAAD;AACE,MAAA,WAAW,EAAEA,WADf;AAEE,MAAA,gBAAgB,EAAEO,gBAFpB;AAGE,MAAA,WAAW,EAAEC,WAHf;AAIE,MAAA,OAAO,EAAE0C,OAJX;AAKE,MAAA,aAAa,EAAEhD,aALjB;AAME,MAAA,oBAAoB,EAAE,KAAKQ,oBAN7B;AAOE,MAAA,UAAU,EAAE,KAAKG,UAPnB;AAQE,MAAA,WAAW,EAAE,KAAKD,WARpB;AASE,MAAA,YAAY,EAAEN;AAThB,MADE,GAWG,IAjDP,EAmDI,CAACH,MAAD,IAAWH,WAAX,IAA0BE,aAA1B,GACA,MAAC,WAAD;AACE,MAAA,UAAU,EAAEJ,UADd;AAEE,MAAA,OAAO,EAAEC,OAFX;AAGE,MAAA,OAAO,EAAEmD,OAHX;AAIE,MAAA,cAAc,EAAE9C,cAJlB;AAKE,MAAA,qBAAqB,EAAEC,qBALzB;AAME,MAAA,WAAW,EAAE,KAAKO,WANpB;AAOE,MAAA,MAAM,EAAET;AAPV,MADA,GAUE,IA7DN,CAPF,CADF;AAyED;;AAnQoC;;AAsQvChC,QAAQ,CAACwF,YAAT,GAAwB;AACtBpE,EAAAA,IAAI,EAAE;AACJO,IAAAA,UAAU,EAAE,CADR;AAEJC,IAAAA,OAAO,EAAE;AAFL,GADgB;AAKtBN,EAAAA,IAAI,EAAE;AAAEO,IAAAA,WAAW,EAAE;AAAf,GALgB;AAMtBE,EAAAA,aAAa,EAAE,KANO;AAOtBC,EAAAA,MAAM,EAAE;AAPc,CAAxB;AAUA,eAAe/C,UAAU,CAACe,QAAD,CAAzB","sourcesContent":["import Layout from '../components/Layout';\nimport fetch from 'isomorphic-unfetch';\nimport Alert from 'react-bootstrap/Alert';\nimport PollChoices from '../components/PollChoices';\nimport PollResults from '../components/PollResults';\nimport { withRouter } from 'next/router'\nimport ErrorPage from './_error';\nimport absoluteUrl from 'next-absolute-url';\nimport InputGroup from 'react-bootstrap/InputGroup';\nimport FormControl from 'react-bootstrap/FormControl';\nimport Button from 'react-bootstrap/Button';\nimport ShareButton from '../components/ShareButton';\nimport { ReportButton } from '../components/Report';\nimport Row from 'react-bootstrap/Row';\nimport Col from 'react-bootstrap/Col';\nimport io from 'socket.io-client';\nimport moment from 'moment';\nimport getMomentTimelimit from '../helpers/momentFunctions';\nimport { FontAwesomeIcon } from '@fortawesome/react-fontawesome';\nimport { faInfoCircle } from '@fortawesome/free-solid-svg-icons';\n\n\nclass PollPage extends React.Component {\n  static async getInitialProps(ctx) {\n    const { origin } = absoluteUrl(ctx.req);\n    const { slug } = ctx.query;\n    let clientIp;\n    if (ctx.req && ctx.req.headers) {\n      clientIp = ctx.req.headers['x-forwarded-for'] || ctx.req.connection.remoteAddress;\n    }\n    const res = await fetch(`${origin}/api/v1/poll/${slug}`, {\n      method: 'POST',\n      headers: { \n        'X-IP': clientIp\n      }\n    });\n    const errorCode = res.status > 200 ? res.status : false\n    const data = await res.json()\n    const url = `${origin}/poll/${slug}`;\n    return { errorCode, poll: data.pollData, user: data.userData, url: url }\n  }\n\n  constructor(props) {\n    super(props);\n\n    this.state = {\n      totalVotes: this.props.poll.totalVotes,\n      results: this.props.poll.results,\n      userDidVote: this.props.user.didVote,\n      revealResults: !this.props.poll.active,\n      resultsLoading: false,\n      refreshResultsLoading: false,\n      selectedVote: null,\n      userDidVoteError: false,\n      submitError: false,\n      timelimit: this.props.poll.timelimit\n    }\n\n    this.updateChoiceSelected = this.updateChoiceSelected.bind(this);\n    this.loadResults = this.loadResults.bind(this);\n    this.submitVote = this.submitVote.bind(this);\n    this.connectSocket = this.connectSocket.bind(this);\n  }\n\n  componentDidMount() {\n    if (this.props.poll.active) {\n      this.connectSocket();\n      const updateTimelimit = setInterval(() => {\n        let timelimit = getMomentTimelimit(this.props.poll.dateCreated, this.props.poll.votingPeriod);\n        this.setState({\n          timelimit: timelimit\n        })\n      }, 60000)\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.socket) {\n      this.socket.close();\n    }\n    clearInterval(this.updateTimelimit);\n  }\n  \n  connectSocket() {\n    this.socket = io();\n    this.socket.emit('joinPollRoom', this.props.router.query.slug);\n\n    this.socket.on('joined', data => {\n      console.log('PollRoom:', data);\n    });\n\n    this.socket.on('updateResults', selectedVote => {\n      const newResults = this.state.results.slice(0);\n      newResults[selectedVote]++;\n      this.setState({\n        results: newResults,\n        totalVotes: this.state.totalVotes + 1\n      });\n    });\n  }\n\n  updateChoiceSelected(e) {\n    this.setState({ selectedVote: e.target.value });\n  }\n\n  async loadResults(e, req) {\n    const { origin } = absoluteUrl(req);\n    const { slug } = this.props.router.query;\n\n    if (this.state.revealResults || this.state.userDidVote || this.props.active) {\n      this.setState({ refreshResultsLoading: true, revealResults: true });\n    } else {\n      this.setState({ revealResults: true, resultsLoading: true });\n    }\n\n    try {\n      const res = await fetch(`${origin}/api/v1/poll/results/${slug}`, {\n        method: 'POST',\n      });\n      const data = await res.json();\n\n      this.setState({\n        totalVotes: data.totalVotes,\n        userDidVote: data.userDidVote,\n        results: data.results,\n        resultsLoading: false,\n        refreshResultsLoading: false,\n      });\n    } catch (err) {\n      \n    }\n  }\n\n  async submitVote(e, req) {\n    e.preventDefault();\n    if(this.state.selectedVote !== null) {\n      const { origin } = absoluteUrl(req);\n      const { slug } = this.props.router.query;\n      try {\n        const res = await fetch(`${origin}/api/v1/poll/vote/${slug}`, {\n          method: 'POST',\n          headers: {\n            'Accept': 'accplication/json',\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({selectedVote: this.state.selectedVote})\n        });\n  \n        const data = await res.json();\n\n        if(data.message === 'error') {\n          this.setState({ userDidVoteError: true });\n        } else {\n          if (localStorage.voteHistory) {\n            let voteHistory = JSON.parse(localStorage.getItem('voteHistory'));\n            voteHistory.unshift({ title: this.props.poll.title, url: this.props.router.query.slug });\n            voteHistory = JSON.stringify(voteHistory)\n            localStorage.setItem('voteHistory', voteHistory);\n          } else {\n            let voteHistory = [];\n            voteHistory.unshift({ title: this.props.poll.title, url: this.props.router.query.slug });\n            voteHistory = JSON.stringify(voteHistory)\n            localStorage.setItem('voteHistory', voteHistory);\n          }\n\n          this.setState({ userDidVote: true });\n        }\n        \n      } catch (err) {\n        this.setState({ submitError: true });\n      }\n    } else {\n      // user didnt select vote\n    }\n  }\n\n  render() {\n    // if not data found for poll\n    if (this.props.errorCode) {\n      return <ErrorPage errorCode={this.props.errorCode} />\n    }\n\n    const { url } = this.props;\n\n    const {\n      title,\n      desc,\n      visibility,\n      active,\n      choices,\n      dateCreated,\n      visits,\n      category,\n    } = this.props.poll;\n\n    const {\n      totalVotes,\n      results,\n      userDidVote,\n      userDidVoteError,\n      revealResults,\n      resultsLoading,\n      refreshResultsLoading,\n      submitError,\n      selectedVote,\n      timelimit\n    } = this.state;\n\n    return (\n      <Layout\n        pageTitle={`Poll - ${title}`}\n        pageDesc={desc}\n        visibility={visibility}\n        path={this.props.router.asPath}\n        ads={true}\n      >\n        <div className='poll-wrapper'>\n          {visibility === 'private' ?\n            <div className='poll-alert'>\n              <Alert variant='danger'>\n                This is a <b>private</b> poll. Please consider before sharing the link.\n              </Alert>\n            </div>\n          : null }\n          <h4 className='poll-title'>{title.length > 0 ? title : 'Untitled'}</h4>\n          <hr />\n          <div className='poll-desc mb-1'>\n            <h6>Description</h6>\n            <div>\n              <p>\n                {desc.length > 0 ? desc : <i>No description</i>}\n              </p>\n              <hr />\n              <div className='poll-stat'>\n                Category: {category}\n              </div>\n              <div className='poll-stat'>\n                {visits} views • {moment.utc(dateCreated).local().format('ll')}\n              </div>\n            </div>\n          </div>\n          <Row>\n            <Col>\n              <div className='poll-options mb-3'>\n                <ShareButton url={url} />\n                <ReportButton urlref={this.props.router.query.slug} polltitle={title} />\n              </div>\n            </Col>\n          </Row>\n          <div className='poll-time'>\n            <h6>\n              <FontAwesomeIcon icon={faInfoCircle} style={{ marginRight: '0.25rem' }} /> <b>{totalVotes}</b> votes • {active && timelimit != 'Voting has ended' ? 'Voting ends in:' : null } <b>{timelimit}</b>\n            </h6>\n          </div>\n          { active && !userDidVote ?\n          <PollChoices\n            userDidVote={userDidVote}\n            userDidVoteError={userDidVoteError}\n            submitError={submitError}\n            choices={choices}\n            revealResults={revealResults}\n            updateChoiceSelected={this.updateChoiceSelected}\n            submitVote={this.submitVote}\n            loadResults={this.loadResults}\n            selectedVote={selectedVote}\n          /> : null }\n\n          { !active || userDidVote || revealResults ?\n            <PollResults\n              totalVotes={totalVotes}\n              results={results}\n              choices={choices}\n              resultsLoading={resultsLoading}\n              refreshResultsLoading={refreshResultsLoading}\n              loadResults={this.loadResults}\n              active={active}\n            />\n            : null }\n        </div>\n      </Layout>\n    )\n  }\n}\n\nPollPage.defaultProps = {\n  poll: {\n    totalVotes: 0,\n    results: [],\n  },\n  user: { userDidVote: false },\n  revealResults: false,\n  active: true\n}\n\nexport default withRouter(PollPage)"]},"metadata":{},"sourceType":"module"}